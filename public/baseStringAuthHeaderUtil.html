<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link href="./components/bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<style>
			.form-container {
				border:1px solid #cecece;
				padding:5px;
				border-radius:5px;
			}

			h4 {
				color: #777;
			}
		</style>
		<!--
		<script type="text/javascript" src="path-to/bower_components/crypto-js/crypto-js.js"></script>
		<script type="text/javascript">
			var encrypted = CryptoJS.AES(...);
			var encrypted = CryptoJS.SHA256(...);
		</script>
		-->
		<script src="./js/BaseStringUtil.js" type="text/javascript"></script>
		<script src="./js/AuthorizationHeaderUtil.js" type="text/javascript"></script>
		<script>
			var viewsOnPage = ["step1", "step2", "step3"];

			function toggleView(view, direction) {
				var forward = (direction == "forward");
				for (var i in viewsOnPage) {
					if (viewsOnPage[i] == view) {
						document.getElementById(viewsOnPage[i]).style.display="block";
						window.location.href="#"+viewsOnPage[i];
						viewFound = true;
					} else {
						document.getElementById(viewsOnPage[i]).style.display="none";
					}
				}
			}

			function toggleClientInputs(optionsList, selectedValue) {
				for (var i = 0; i < optionsList.length; i++) {
					if (typeof optionsList[i].value != "undefined") {
						var toDisplay = "none";
						if (optionsList[i].value == selectedValue) {
							toDisplay = "block";
						}

						var clientInputs = document.getElementsByName("clientInput_"+optionsList[i].value);
						if (clientInputs && clientInputs.length > 0) {
							for (var j = 0; j < clientInputs.length; j++) {
								if (typeof clientInputs[j] != "undefined") {
									clientInputs[j].style.display=toDisplay;
								}
							}
						}
					}
				}
			}

			function updateApplicationId(client_id) {
				if (document.getElementById('form_apex_app_id').disabled) {
					document.getElementById('form_apex_app_id').value=client_id;
				}
			}

			function linkApplicationId(isLinked) {
				if (isLinked) {
					document.getElementById('form_apex_app_id').value=document.getElementById('client_id').value;
					document.getElementById('form_apex_app_id').disabled=true;
				} else {
					document.getElementById('form_apex_app_id').disabled=false;
				}
			}

			function populateApexParameters() {
				document.getElementById('form_apex_nonce').value=Math.floor(Math.random() * 100000000000);
				document.getElementById('form_apex_timestamp').value=Date.parse(new Date());
			}


			///////////////////////////
			// Auth Header functions //
			///////////////////////////
			function formAuthorizationHeader() {
				var authHeaderResult = {};
				var params = {};

				var form_env = document.getElementById('form_env');
				params.environment=form_env.options[form_env.selectedIndex].value;

				var form_api = document.getElementById('form_api');
				params.api=form_api.options[form_api.selectedIndex].value;

				// APEX params
				params.realm = document.getElementById('form_realm').value;
				params.apex_app_id = document.getElementById('form_apex_app_id').value;
				params.apex_nonce = document.getElementById('form_apex_nonce').value;
				params.apex_signature_method = document.getElementById('form_apex_signature_method').value;
				params.apex_signature = document.getElementById('form_apex_signature').value;
				params.apex_timestamp = document.getElementById('form_apex_timestamp').value;
				params.apex_version = document.getElementById('form_apex_version').value;

				if (params.api == 'PERSON') {
					params.Bearer = document.getElementById('form_jwt').value;
				}

				var authHeaderResult = AuthorizationHeaderGenerator.generate(params);

				showAuthorizationHeader(authHeaderResult);
				var sampleRequest = document.getElementById("sampleRequest").value;
				sampleRequest = sampleRequest.replace("{AUTHORIZATION_HEADER}", authHeaderResult.value);
				document.getElementById("sampleRequest").value = sampleRequest;
			}
			
			function showAuthorizationHeader(authHeaderResult) {
				if (authHeaderResult.error) {
					document.getElementById("formulatedAuthHeader").value = authHeaderResult.error;
				} else {
					document.getElementById("formulatedAuthHeader").value = authHeaderResult.value;
				}

				toggleView("step3");
			}

			///////////////////////////
			// Base String functions //
			///////////////////////////
			function formBaseString() {
				var params = {};

				var form_env = document.getElementById('form_env');
				params.environment=form_env.options[form_env.selectedIndex].value;

				var form_api = document.getElementById('form_api');
				params.api=form_api.options[form_api.selectedIndex].value;

				// APEX params
				params.apex_app_id = document.getElementById('form_apex_app_id').value;
				params.apex_nonce = document.getElementById('form_apex_nonce').value;
				params.apex_signature_method = document.getElementById('form_apex_signature_method').value;
				params.apex_timestamp = document.getElementById('form_apex_timestamp').value;
				params.apex_version = document.getElementById('form_apex_version').value;

				if (params.api == 'TOKEN') {
					params.client_id = document.getElementById('form_client_id_TOKEN').value;
					params.client_secret = document.getElementById('form_client_secret').value;
					params.grant_type = document.getElementById('form_grant_type').value;
					params.code = document.getElementById('form_code').value;
					params.redirect_uri = document.getElementById('form_redirect_uri').value;
				}
				if (params.api == 'PERSON') {
					params.client_id = document.getElementById('form_client_id_PERSON').value;
					params.uinfin = document.getElementById('form_uinfin_PERSON').value;
					params.txnNo = document.getElementById('form_txnNo').value;
					params.attributes = document.getElementById('form_attributes').value;
				}


				var baseStringResult = BaseStringGenerator.generateBaseString(params);
				showBaseString(baseStringResult);
				document.getElementById("sampleRequest").value = baseStringResult.sampleRequest;
			}
			
			
			function showBaseString(baseStringResult) {
				if (baseStringResult.error) {
					document.getElementById("formulatedBaseString").value = baseStringResult.error;
				} else {
					document.getElementById("formulatedBaseString").value = baseStringResult.value;
				}

				toggleView("step2");
				window.location.href="#step2";
			}

			function clearCompareResult(resultElementId) {
				var resultElement = document.getElementById(resultElementId);
				resultElement.className="btn btn-primary";
				resultElement.innerHTML="Compare";
			}

			function compareValues(textBoxA, textBoxB, resultElementId) {
				var same = document.getElementById(textBoxA).value == document.getElementById(textBoxB).value;
				var resultElement = document.getElementById(resultElementId);
				if (same) {
					resultElement.className="btn btn-success";
					resultElement.innerHTML="The values are the same";
				} else {
					resultElement.className="btn btn-danger";
					resultElement.innerHTML="The values are different";
				}
			}
		</script>
	</head>
	<body onLoad="populateApexParameters();">
		<nav id="mainNav" class="navbar navbar-default navbar-fixed-top">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapsed">
						<span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
					</button>
					<a class="navbar-brand page-scroll" href="#step1" onclick="toggleView('step1')">Base String and Authorization Header Utility</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="navbar-collapsed">

				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container-fluid -->
		</nav>
		<div class="container-fluid">
			<h2><strong>&nbsp;</strong></h2>
			<div id="step1">
				<h2><small style="color:#000;"><b>Step 1: Formulate Base String</b></small></h2>
				<h4 style="color:#777">Environment</h4>
				<div class="form-container">
					<div class="form-group row">
						<div class="col-md-6">
							<label for="form_env">Environment</label>
							<select id="form_env" class="form-control">
								<option value="STAGE" selected>Staging</option>
								<option value="PROD">Production</option>
							</select>
						</div>

						<div class="col-md-6">
							<label for="form_api">API</label>
							<select id="form_api" class="form-control" onchange="toggleClientInputs(this.options, this.options[this.selectedIndex].value);">
								<option value="TOKEN" selected>Token</option>
								<option value="PERSON">Person</option>
							</select>
						</div>
					</div>
				</div>
				<h4>APEX Parameters <button type="button" class="btn btn-default" onclick="populateApexParameters();">Refresh</button></h4>
				<div class="form-container">
					<div class="form-group row">
						<div class="col-md-6">
							<label for="form_apex_app_id">Application ID (apex_app_id)</label>
							<input type="text" class="form-control" id="form_apex_app_id" placeholder="Application ID" disabled>
							<p class="help-block"><input type="checkbox" checked onclick="linkApplicationId(this.checked);">&nbsp;&nbsp;&nbsp;(Linked to Client ID - default)</input></p>
						</div>
						<div class="col-md-6">
							<label for="form_realm">Realm (realm)</label>
							<input type="text" class="form-control" id="form_realm" placeholder="realm">
						</div>
					</div>
					<div class="form-group row">
						<div class="col-md-3">
							<label for="form_apex_nonce">Nonce (apex_nonce)</label>
							<input type="text" class="form-control" id="form_apex_nonce" placeholder="Nonce">
						</div>
						<div class="col-md-3">
							<label for="form_apex_signature_method">Signature Method (apex_signature_method)</label>
							<input type="text" class="form-control" id="form_apex_signature_method" disabled value="SHA256withRSA">
						</div>
						<div class="col-md-3">
							<label for="form_apex_timestamp">Timestamp (apex_timestamp)</label>
							<input type="text" class="form-control" id="form_apex_timestamp" placeholder="Time in milliseconds">
						</div>
						<div class="col-md-3">
							<label for="form_apex_version">Version (apex_version)</label>
							<input type="text" class="form-control" id="form_apex_version" disabled value="1.0">
						</div>
					</div>
				</div>
				<h4>Client Inputs</h4>
				<div name="clientInput_TOKEN" class="form-container">
					<div class="form-group row">
						<div class="col-md-3">
							<label for="form_client_id_TOKEN">Client ID (client_id)</label>
							<input type="text" class="form-control" id="form_client_id_TOKEN" placeholder="Client ID" onkeyup="updateApplicationId(this.value);">
						</div>
						<div class="col-md-6">
							<label for="form_client_secret">Client Secret (client_secret)</label>
							<input type="text" class="form-control" id="form_client_secret" placeholder="Client Secret">
						</div>
						<div class="col-md-3">
							<label for="form_grant_type">Grant Type (grant_type)</label>
							<input type="text" class="form-control" id="form_grant_type" disabled value="authorization_code">
						</div>
						<div class="col-md-12">
							<label for="form_code">Authorization Code (code)</label>
							<input type="text" class="form-control" id="form_code" placeholder="Authorization Code">
						</div>
						<div class="col-md-12">
							<label for="form_redirect_uri">Redirect URI (redirect_uri)</label>
							<input type="text" class="form-control" id="form_redirect_uri" placeholder="Redirect URI">
						</div>
					</div>
				</div>

				<div name="clientInput_PERSON" class="form-container" style="display:none;">
					<div class="form-group row">
						<div class="col-md-3">
							<label for="form_client_id_PERSON">Client ID (client_id)</label>
							<input type="text" class="form-control" id="form_client_id_PERSON" placeholder="Client ID" onkeyup="updateApplicationId(this.value);">
						</div>
						<div class="col-md-3">
							<label for="form_uinfin_PERSON">UINFIN (uinfin)</label>
							<input type="text" class="form-control" id="form_uinfin_PERSON" placeholder="UINFIN">
						</div>
						<div class="col-md-3">
							<label for="form_txnNo">Transaction No (txnNo)</label>
							<input type="text" class="form-control" id="form_txnNo" placeholder="Transaction No">
						</div>
						<div class="col-md-12">
							<label for="form_attributes">Attributes (attributes)</label>
							<input type="text" class="form-control" id="form_attributes" placeholder="Attributes">
						</div>
					</div>
				</div>
				<p></p>
				<button type="button" class="btn btn-primary" onclick="formBaseString();">Form the Base String</button>


			</div>

			<!-- Step 2: Input Signature and JWT -->
			<div id="step2" style="display:none">
				<h2><small style="color:#000;">Step 2: Provide Signed base string</small></h2>
				<h4>Base String</h4>
				<div class="form-container">
					<div class="form-group row">
						<div class="col-md-6">
							<label for="formulatedBaseString" style="color:green">Base String Generated from Step 1</label>
							<span style="float:right;margin-bottom:10px">
								<button type="button" class="btn btn-default" onclick="clearCompareResult('baseStringCompare');document.getElementById('formulatedBaseString').value = BaseStringGenerator.prettyPrint(document.getElementById('formulatedBaseString').value)">Pretty Print</button>
								<button type="button" class="btn btn-default" onclick="clearCompareResult('baseStringCompare');document.getElementById('formulatedBaseString').value = BaseStringGenerator.concat(document.getElementById('formulatedBaseString').value)">Raw</button>
							</span>
							<textarea id="formulatedBaseString" class="form-control" disabled rows="10" style="color:green"></textarea>
							<p class="help-block">* Compare the above generated Base String against your application generated base string.</p>
						</div>
						<div class="col-md-6">
							<label for="userInputBaseString" style="color:green">User Generated Base String</label>
							<span style="float:right;margin-bottom:10px">
								<button type="button" class="btn btn-default" onclick="clearCompareResult('baseStringCompare');document.getElementById('userInputBaseString').value = BaseStringGenerator.prettyPrint(document.getElementById('userInputBaseString').value)">Pretty Print</button>
								<button type="button" class="btn btn-default" onclick="clearCompareResult('baseStringCompare');document.getElementById('userInputBaseString').value = BaseStringGenerator.concat(document.getElementById('userInputBaseString').value)">Raw</button>
							</span>
							<textarea id="userInputBaseString" class="form-control" rows="10" style="color:green" onkeyup="clearCompareResult('baseStringCompare');" onchange="clearCompareResult('baseStringCompare');"></textarea>
							<p class="help-block">* Paste your generated Base String here.</p>
						</div>
						<div class="col-md-12" style="text-align:center">
							<button width="50px" id="baseStringCompare" type="button" class="btn btn-primary" onclick="compareValues('formulatedBaseString', 'userInputBaseString', 'baseStringCompare');">Compare</button>
						</div>
					</div>
					<div class="form-group row">
						<div class="col-md-12">
							<label for="form_apex_signature">Signature (apex_signature)</label>
							<textarea id="form_apex_signature" class="form-control"></textarea>
							<p class="help-block">Sign the base string with RSA-SHA256 and put the result here.</p>
						</div>
					</div>
					<div name="clientInput_PERSON" class="form-group row" style="display:none">
						<div class="col-md-12">
							<label for="form_jwt">JSON Web Token</label>
							<textarea id="form_jwt" class="form-control"></textarea>
							<p class="help-block">Paste the JWT you obtained from the /token API here</p>
						</div>
					</div>

				</div>

				<p></p>
				<button type="button" class="btn btn-primary" onclick="formAuthorizationHeader();">Form the Authorization Header</button>
			</div>

			<!-- Step 3: Authorization Header -->
			<div id="step3" style="display:none">
				<h2><small style="color:#000;">Step 3: Verify Authorization Header</small></h2>
				<h4>Authorization Header</h4>
				<div class="form-container">
					<div class="form-group row">
						<div class="col-md-6">
							<label for="formulatedAuthHeader" style="color:green">Authorization Header Generated from Step 2</label>
							<span style="float:right;margin-bottom:10px">
								<button type="button" class="btn btn-default" onclick="clearCompareResult('authorizationHeaderCompare');document.getElementById('formulatedAuthHeader').value = AuthorizationHeaderGenerator.prettyPrint(document.getElementById('formulatedAuthHeader').value)">Pretty Print</button>
								<button type="button" class="btn btn-default" onclick="clearCompareResult('authorizationHeaderCompare');document.getElementById('formulatedAuthHeader').value = AuthorizationHeaderGenerator.concat(document.getElementById('formulatedAuthHeader').value)">Raw</button>
							</span>
							<textarea id="formulatedAuthHeader" class="form-control" disabled style="color:green" rows="8"></textarea>
							<p class="help-block">* Compare the above generated Authorization Header against your application generated Authorization Header.</p>
						</div>
						<div class="col-md-6">
							<label for="userInputAuthHeader" style="color:green">User Generated Authorization Header </label>
							<span style="float:right;margin-bottom:10px">
								<button type="button" class="btn btn-default" onclick="clearCompareResult('authorizationHeaderCompare');document.getElementById('userInputAuthHeader').value = AuthorizationHeaderGenerator.prettyPrint(document.getElementById('userInputAuthHeader').value)">Pretty Print</button>
								<button type="button" class="btn btn-default" onclick="clearCompareResult('authorizationHeaderCompare');document.getElementById('userInputAuthHeader').value = AuthorizationHeaderGenerator.concat(document.getElementById('userInputAuthHeader').value)">Raw</button>
							</span>
							<textarea id="userInputAuthHeader" class="form-control" style="color:green" rows="8" onkeyup="clearCompareResult('authorizationHeaderCompare');" onchange="clearCompareResult('authorizationHeaderCompare');"></textarea>
							<p class="help-block">* Paste your generated Authorization Header here to compare.</p>
						</div>
						<div class="col-md-12" style="text-align:center">
							<button id="authorizationHeaderCompare" type="button" class="btn btn-primary" onclick="compareValues('formulatedAuthHeader', 'userInputAuthHeader', 'authorizationHeaderCompare');">Compare</button>
						</div>
					</div>
				</div>

				<h4>Sample Request</h4>
				<div class="form-container">
					<div class="form-group row">
						<div class="col-md-12">
							<textarea id="sampleRequest" style="color:green" rows=15 class="form-control" disabled></textarea>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
